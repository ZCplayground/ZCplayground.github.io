<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="到目前为止我们只考虑了直线代码的执行行为，也就是指令一条接着一条执行。C语言中的某些语句，比如条件语句、循环、分支语句，要求有条件地执行，或根据某些表达式的结果决定操作的顺序。机器代码提供基本的低级机制来实现有条件的行为：测试数据值，然后根据测试结果来改变控制流或数据流。 先介绍通过控制流来实现有条件的行为。用jump指令可以改变一组机器代码的执行顺序。jump指令指定控制应该传递到程序的哪个其他">
<meta property="og:type" content="article">
<meta property="og:title" content="【CSAPP笔记】6. 汇编语言——控制">
<meta property="og:url" content="https://zcplayground.github.io/2017/06/25/csapp-6-Machine-Prog-Control/index.html">
<meta property="og:site_name" content="chaz">
<meta property="og:description" content="到目前为止我们只考虑了直线代码的执行行为，也就是指令一条接着一条执行。C语言中的某些语句，比如条件语句、循环、分支语句，要求有条件地执行，或根据某些表达式的结果决定操作的顺序。机器代码提供基本的低级机制来实现有条件的行为：测试数据值，然后根据测试结果来改变控制流或数据流。 先介绍通过控制流来实现有条件的行为。用jump指令可以改变一组机器代码的执行顺序。jump指令指定控制应该传递到程序的哪个其他">
<meta property="og:image" content="http://osax8w13y.bkt.clouddn.com/6-set.png">
<meta property="og:image" content="http://osax8w13y.bkt.clouddn.com/6-jump.png">
<meta property="og:image" content="http://osax8w13y.bkt.clouddn.com/6-C%20compling.png">
<meta property="og:updated_time" content="2017-06-29T09:31:18.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="【CSAPP笔记】6. 汇编语言——控制">
<meta name="twitter:description" content="到目前为止我们只考虑了直线代码的执行行为，也就是指令一条接着一条执行。C语言中的某些语句，比如条件语句、循环、分支语句，要求有条件地执行，或根据某些表达式的结果决定操作的顺序。机器代码提供基本的低级机制来实现有条件的行为：测试数据值，然后根据测试结果来改变控制流或数据流。 先介绍通过控制流来实现有条件的行为。用jump指令可以改变一组机器代码的执行顺序。jump指令指定控制应该传递到程序的哪个其他">
<meta name="twitter:image" content="http://osax8w13y.bkt.clouddn.com/6-set.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://zcplayground.github.io/2017/06/25/csapp-6-Machine-Prog-Control/"/>





  <title>【CSAPP笔记】6. 汇编语言——控制 | chaz</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  















  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">chaz</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://zcplayground.github.io/2017/06/25/csapp-6-Machine-Prog-Control/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chaz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="chaz">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">【CSAPP笔记】6. 汇编语言——控制</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-25T22:56:55+08:00">
                2017-06-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CSAPP/" itemprop="url" rel="index">
                    <span itemprop="name">CSAPP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>到目前为止我们只考虑了直线代码的执行行为，也就是指令一条接着一条执行。C语言中的某些语句，比如条件语句、循环、分支语句，要求有条件地执行，或根据某些表达式的结果决定操作的顺序。机器代码提供基本的低级机制来实现有条件的行为：测试数据值，然后根据测试结果来改变<strong>控制流</strong>或<strong>数据流</strong>。</p>
<p>先介绍通过控制流来实现有条件的行为。用<code>jump</code>指令可以改变一组机器代码的执行顺序。<code>jump</code>指令指定控制应该传递到程序的哪个其他部分，这可能依赖于某个测试的结果。</p>
<h1 id="条件码"><a href="#条件码" class="headerlink" title="条件码"></a>条件码</h1><p>除了整数寄存器，CPU 还负责维护一组<strong>单个位</strong>的<strong>条件码</strong>（condition code）寄存器。最常用的条件码有：</p>
<table>
<thead>
<tr>
<th>条件码</th>
<th>作用</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>CF</td>
<td>进位标志，carry</td>
<td>最近的操作使得最高位产生了进位。可以用来检查无符号操作数的溢出。</td>
</tr>
<tr>
<td>ZF</td>
<td>零标志，zero</td>
<td>最近的操作得出的结果为零</td>
</tr>
<tr>
<td>SF</td>
<td>符号标志，sign</td>
<td>最近的操作得出的结果为负</td>
</tr>
<tr>
<td>OF</td>
<td>溢出标志，overflow</td>
<td>最近的操作导致了一个补码溢出（正溢或负溢）</td>
</tr>
</tbody>
</table>
<p>假设我们用一条 ADD 指令完成一个 C语言表达式 <code>t=a+b</code>的功能，这里变量都是整型。然后，条件码就是根据下面的表达式设置的：</p>
<table>
<thead>
<tr>
<th>条件码</th>
<th>通过下面的表达式来设置</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>CF</td>
<td>(unsigned) t &lt; (unsigned) a</td>
<td>和比加数小，说明出现无符号溢出</td>
</tr>
<tr>
<td>ZF</td>
<td>(t == 0)</td>
<td>结果为零</td>
</tr>
<tr>
<td>SF</td>
<td>(t &lt; 0)</td>
<td>结果为负数</td>
</tr>
<tr>
<td>OF</td>
<td>(a &lt; 0 == b &lt; 0) &amp;&amp; (t &lt; 0 != a &lt; 0)</td>
<td>a、b同时为负，而和为正；或a、b同时为正，而和为负。说明出现了有符号溢出</td>
</tr>
</tbody>
</table>
<h2 id="基础的整数算术操作"><a href="#基础的整数算术操作" class="headerlink" title="基础的整数算术操作"></a>基础的整数算术操作</h2><p>下面列出汇编中基础的整数算术操作：</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>效果</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>leal S, D</td>
<td>&amp;S → D</td>
<td>加载地址</td>
</tr>
<tr>
<td>INC D</td>
<td>D + 1 → D</td>
<td>自增1</td>
</tr>
<tr>
<td>DEC D</td>
<td>D - 1 → D</td>
<td>自减1</td>
</tr>
<tr>
<td>NEG D</td>
<td>-D → D</td>
<td>取负</td>
</tr>
<tr>
<td>NOT D</td>
<td>~D → D</td>
<td>取补</td>
</tr>
<tr>
<td>ADD S, D</td>
<td>S + D → D</td>
<td>加</td>
</tr>
<tr>
<td>SUB S, D</td>
<td>S - D → D</td>
<td>减</td>
</tr>
<tr>
<td>IMUL S, D</td>
<td>S * D → D</td>
<td>乘</td>
</tr>
<tr>
<td>XOR S, D</td>
<td>S ^ D → D</td>
<td>异或</td>
</tr>
<tr>
<td>OR S, D</td>
<td>S `</td>
<td>` D → D</td>
<td>与</td>
</tr>
<tr>
<td>AND S, D</td>
<td>S &amp; D → D</td>
<td>或</td>
</tr>
<tr>
<td>SAL k, D</td>
<td>D &lt;&lt; k → D</td>
<td>左移</td>
</tr>
<tr>
<td>SAR k, D</td>
<td>D &gt;&gt; k → D</td>
<td>算术右移</td>
</tr>
<tr>
<td>SHL k, D</td>
<td>D &gt;&gt; k → D</td>
<td>逻辑右移</td>
</tr>
</tbody>
</table>
<p><code>leal</code> 指令不改变任何条件码，因为它是用来做地址计算的。除此之外，其他指令都会会涉及改变条件码。</p>
<h2 id="设置条件码的特殊指令"><a href="#设置条件码的特殊指令" class="headerlink" title="设置条件码的特殊指令"></a>设置条件码的特殊指令</h2><p>有两类指令，它们只设置条件码而不改变其他任何寄存器。它们是比较和测试指令，<code>CMP S2, S1</code> 和 <code>TEST S2, S1</code>，比较指令是基于两个操作数的差来设置条件码。测试指令是给予两个数的按位与来设置条件码。常见的用法有：两个操作数是相同的（例如用指令 <code>testl %eax, %eax</code>来测试寄存器中存的是零、正数还是负数）；或者有一个操作数是一个掩码，指定哪些位应该被测试。</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>基于</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>CMP S2, S1</td>
<td>S1 - S2</td>
<td>比较</td>
</tr>
<tr>
<td>TEST S2, S1</td>
<td>S1 &amp; S2</td>
<td>测试</td>
</tr>
</tbody>
</table>
<h2 id="访问条件码：SET指令"><a href="#访问条件码：SET指令" class="headerlink" title="访问条件码：SET指令"></a>访问条件码：SET指令</h2><p>条件码通常不直接读取。有三种方法可以使用，下面依次介绍他们</p>
<ol>
<li>可以根据条件码的组某个组合将一个字节设置为 0 或 1 。</li>
<li>可以跳转到程序的其他部分。</li>
<li>可以有条件地传送数据。</li>
</ol>
<p>SET指令根据条件码的组合，将某一个字节设置为 0 或者 1 。指令名字后面的后缀指明了他们的功效和需要考虑的条件码组合的不同。</p>
<p><img src="http://osax8w13y.bkt.clouddn.com/6-set.png" alt=""></p>
<table>
<thead>
<tr>
<th>指令</th>
<th>参考英文</th>
<th>效果</th>
<th>注释</th>
</tr>
</thead>
<tbody>
<tr>
<td>sete D</td>
<td>equal</td>
<td>相等/零</td>
<td></td>
</tr>
<tr>
<td>setne D</td>
<td>not equal</td>
<td>不等/非零</td>
<td></td>
</tr>
<tr>
<td>sets D</td>
<td>sign / negetive</td>
<td>负数</td>
<td></td>
</tr>
<tr>
<td>setns D</td>
<td>nonnegtive</td>
<td>非负数</td>
<td></td>
</tr>
<tr>
<td>setg D</td>
<td>greater</td>
<td>大于（有符号&gt;）</td>
<td>a与b的差不为零，差值为正时不能溢出，差值为负时必须溢出，则可以认定a大于b</td>
</tr>
<tr>
<td>setge D</td>
<td>greater or equal</td>
<td>大于等于（有符号≥）</td>
<td>与上面条件相似，只是去掉a与b差值不能为零的限制</td>
</tr>
<tr>
<td>setl D</td>
<td>less</td>
<td>小于（有符号&lt;）</td>
<td>a与b的差值为正的时候必须溢出，或a与b的差值为负但没有发生溢出，则可以认定a小于b</td>
</tr>
<tr>
<td>setle D</td>
<td>less or eqaul</td>
<td>小于等于（有符号≤）</td>
<td>与上面条件相似，只是多加了一条当a与b的差值为0时也可以认定a小于等于b</td>
</tr>
<tr>
<td>seta D</td>
<td>above</td>
<td>超过（无符号&gt;）</td>
<td>计算无符号数a和b的差值时最高位没有进位，且结果也不等于零，认为无符号数a大于b</td>
</tr>
<tr>
<td>setae D</td>
<td>above or equal</td>
<td>超过或相等（无符号≥）</td>
<td>与上面条件相似，但去掉不等于零的限制</td>
</tr>
<tr>
<td>setb D</td>
<td>below</td>
<td>低于（无符号&lt;）</td>
<td>计算无符号数a和b的差值时最高位没有进位</td>
</tr>
<tr>
<td>setbe D</td>
<td>below or equal</td>
<td>低于或等于（无符号≤）</td>
<td>与上面条件相似，但多加了一条当a与b的差值为0时也可以认定a小于等于b</td>
</tr>
</tbody>
</table>
<p>SET指令的操作数是8个单字节寄存器之一，或是存储一个字节的存储器位置，然后将这个字节设置为 0 或 1。下面看一个典型的计算C语言表达式 <code>x &gt; y</code> 的指令序列。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">gt</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> x &gt; y;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对应的汇编指令序列：</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cmpl    <span class="symbol">%eax</span>, <span class="symbol">%edx</span>     # Compare <span class="keyword">x</span> : y</div><div class="line">setl    <span class="symbol">%al</span>            # Set low byte of <span class="symbol">%eax</span> <span class="keyword">to</span> <span class="number">0</span> <span class="keyword">or</span> <span class="number">1</span></div><div class="line">movzbl  <span class="symbol">%al</span>, <span class="symbol">%eax</span>      # Set remaining bytes of <span class="symbol">%eax</span> <span class="keyword">to</span> <span class="number">0</span></div></pre></td></tr></table></figure>
<p><code>%al</code> 是一个单字节的寄存器元素，变量x和y分别存放在<code>%eax</code>和<code>%edx</code>中，然后使用<code>setl</code>指令，如果 a &gt; b，则把<code>%al</code>设置为 1，反之则设置为 0。<code>movzbl</code>是将做了零扩展的字节传送到字，这么做是因为我们为了得到一个32位结果，就要把高24位进行扩展，这里是全部清 0。</p>
<p>注意机器代码如何区别有符号和无符号值是很重要的。同C语言不同，机器代码不会将一个内存中的值和一个具体的数据类型联系起来。有些情况下，对于无符号数和有符号数使用的操作是相同的，根本原因是因为许多算术运算对于两者都有一样的位级行为。另外的一些情况下，对于无符号数和有符号数就要采取不同的操作，比方说不同版本的移位运算，乘除法，不同的条件码组合。</p>
<h1 id="条件分支"><a href="#条件分支" class="headerlink" title="条件分支"></a>条件分支</h1><p>正常执行情况下，指令会按照它们的顺序一条条执行。<strong>跳转</strong>（jump）指令会导致程序执行切换到一个全新的位置。</p>
<h2 id="jump-指令的字节编码"><a href="#jump-指令的字节编码" class="headerlink" title="jump 指令的字节编码"></a>jump 指令的字节编码</h2><p>在汇编代码中，跳转的目的地通常是用一个标号（label）来标识。考虑下列的汇编代码序列（完全人为编造）：</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"> movl  $0, %eax</div><div class="line"> jmp   .L1</div><div class="line"> movl  (%eax), %edx</div><div class="line">.L1:</div><div class="line"> popl %edx</div></pre></td></tr></table></figure>
<p>指令<code>jmp</code>会导致跳过<code>movl</code>指令，从<code>pop</code>处开始执行。<code>jmp</code>是<strong>无条件跳转</strong>，而下表列出来的跳转指令都是<strong>有条件跳转</strong>，它们根据条件码组合进行跳转，或选择不跳转，继续执行下一条指令。条件码的组合与其意义和<code>SET</code>指令类似。</p>
<p><img src="http://osax8w13y.bkt.clouddn.com/6-jump.png" alt=""></p>
<p>前面提到，PC（program counter）——程序计数器的作用是指示要执行的下一条指令的地址。跳转指令有几种不同的编码方法，最常用的是<strong>PC相关寻址</strong>。它们会<strong>将目标指令的地址与紧跟在跳转指令后面那条指令的地址之间的差值作为编码</strong>。当执行PC相关寻址时，PC的值是跳转指令后面那条指令的地址，而不是跳转指令本身的地址。下面看一个例子：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 一段汇编代码：</span></div><div class="line"></div><div class="line">  jle   <span class="string">.L2</span></div><div class="line"><span class="string">.L5</span>:</div><div class="line">  <span class="string">....</span></div><div class="line">  <span class="string">....</span></div><div class="line">  jg    <span class="string">.L5</span></div><div class="line"><span class="string">.L2</span>:</div><div class="line">  <span class="string">....</span></div></pre></td></tr></table></figure>
<p>下面是汇编器产生的 .o 文件的反汇编版本：</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="number">8</span>:  <span class="number">7</span>e <span class="number">0</span>d     jle  <span class="number">17</span>&lt;main+<span class="number">0x17</span>&gt;</div><div class="line">a:  <span class="number">89</span> d0     ..........</div><div class="line">....</div><div class="line">....</div><div class="line"><span class="number">15</span>: <span class="number">7</span>f f3     jg   a&lt;main+<span class="number">0xa</span>&gt;</div><div class="line"><span class="number">17</span>: <span class="number">89</span> d0     ..........</div></pre></td></tr></table></figure>
<p>在反汇编中，第一行是跳转指令<code>jle</code>，它指定了跳转目标为<code>0x17</code>，也就是汇编代码中标签<code>L2</code>。第二行是跳转指令<code>jg</code>，它指定了跳转目标为<code>0xa</code>，也就是汇编代码中的标签<code>L5</code>。观察<strong>指令的字节编码</strong>，可以看到第一条跳转指令的目标编码（在第二个字节中）是<code>0xd</code>，将其加上PC的值，（PC值是跳转指令后面那条指令的地址：<code>0xa</code>）得到结果是<code>0x17</code>，就是正确的地址。</p>
<h2 id="翻译条件分支"><a href="#翻译条件分支" class="headerlink" title="翻译条件分支"></a>翻译条件分支</h2><p>将条件表达式和语句从C语言翻译成机器代码，一个方法就是使用C语言中的 goto 语句。使用 goto 语句常常被认为是一种不好的语言风格，因为它破坏了程序的结构性，并使代码非常难以阅读和调试。这里我们使用它是为了描述汇编代码在完成代码程序控制转移的流程。</p>
<p>C语言中的if-else的通用形式模板是这样的：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>(<span class="built_in">text</span>-expr)</div><div class="line">    <span class="keyword">then</span>-statement</div><div class="line"><span class="keyword">else</span></div><div class="line">    <span class="keyword">else</span>-statement</div></pre></td></tr></table></figure>
<p>对应汇编实现的通用形式模板是这样的：<br><figure class="highlight sqf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">    t = <span class="built_in">text</span>-expr</div><div class="line">    <span class="keyword">if</span>(!t)</div><div class="line">        <span class="built_in">goto</span> <span class="literal">false</span>;</div><div class="line">    <span class="keyword">then</span>-statement</div><div class="line">    <span class="built_in">goto</span> done;</div><div class="line"><span class="literal">false</span>:</div><div class="line">    <span class="keyword">else</span>-statement;</div><div class="line">done:</div></pre></td></tr></table></figure></p>
<p>下面举一个具体的例子：</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">//一份返回绝对值差值的C语言代码</div><div class="line"><span class="built_in">int</span> absdiff(<span class="built_in">int</span> x, <span class="built_in">int</span> y)</div><div class="line">&#123;</div><div class="line">    <span class="built_in">int</span> <span class="literal">result</span>;</div><div class="line">    <span class="keyword">if</span> (x &lt; y)</div><div class="line">        <span class="literal">result</span> = y - x;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="literal">result</span> = x - y;</div><div class="line">    <span class="keyword">return</span> <span class="literal">result</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//与之等价的goto版本</div><div class="line"><span class="built_in">int</span> absdiff_goto(<span class="built_in">int</span> x, <span class="built_in">int</span> y)</div><div class="line">&#123;</div><div class="line">    <span class="built_in">int</span> <span class="literal">result</span>;</div><div class="line">    <span class="keyword">if</span> (x &gt;= y) goto <span class="type">Else</span>;</div><div class="line">    <span class="literal">result</span> = y - x;</div><div class="line">    goto <span class="type">Done</span>;</div><div class="line"><span class="type">Else</span>:</div><div class="line">    <span class="literal">result</span> = x - y;</div><div class="line"><span class="type">Done</span>:</div><div class="line">    <span class="keyword">return</span> <span class="literal">result</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"># 汇编代码</div><div class="line"></div><div class="line"># 变量<span class="keyword">x</span>存放在 <span class="symbol">%ebp</span>+<span class="number">8</span>，变量y存放在 <span class="symbol">%ebp</span>+<span class="number">12</span></div><div class="line"></div><div class="line">movl    <span class="number">8</span>(<span class="symbol">%ebp</span>), <span class="symbol">%edx</span>       # 将变量<span class="keyword">x</span>存放在寄存器<span class="symbol">%edx</span>中</div><div class="line">movl    <span class="number">12</span>(<span class="symbol">%ebp</span>), <span class="symbol">%eax</span>      # 将变量y存放在寄存器<span class="symbol">%eax</span>中</div><div class="line">cmpl    <span class="symbol">%eax</span>, <span class="symbol">%edx</span>          # 比较 <span class="keyword">x</span>:y</div><div class="line">jge     .L<span class="number">2</span>                 # 如果满足大于或等于，跳转到标签L<span class="number">2</span></div><div class="line">subl    <span class="symbol">%edx</span>, <span class="symbol">%eax</span>          # y - <span class="keyword">x</span> 结果放到 <span class="symbol">%eax</span></div><div class="line">jmp     .L<span class="number">3</span></div><div class="line"></div><div class="line">.L<span class="number">2</span>:</div><div class="line">subl    <span class="symbol">%eax</span>, <span class="symbol">%edx</span>          # <span class="keyword">x</span> - y 结果放到 <span class="symbol">%edx</span></div><div class="line">movl    <span class="symbol">%edx</span>, <span class="symbol">%eax</span>          # 将 <span class="symbol">%edx</span> 里的结果放到 <span class="symbol">%eax</span></div><div class="line"></div><div class="line">.L<span class="number">3</span>:                        # return 的是 <span class="symbol">%eax</span> 里面的值</div></pre></td></tr></table></figure>
<p>逆向工程（reverse engineer），通过分析汇编代码，来推出C语言代码，做这样的练习对理解汇编知识和原理有很大的帮助。只看上面这段汇编代码，你能不能推出C语言的代码来呢？</p>
<h1 id="条件传送"><a href="#条件传送" class="headerlink" title="条件传送"></a>条件传送</h1><p>条件分支的操作方法是实现<strong>控制</strong>的转移——当条件满足时，沿着一条路径进行，不满足时，沿另一条路径进行。这种机制简单明了，但在现代处理器上，会非常的低效率。为什么呢？可以想象，如果一定要彻底执行完一条指令之后才开始新的一条指令，那机器的性能没有被最大程度地发挥。因此 CPU 都是依靠流水线（pipeline）进行操作的。例如一条指令需要ABCDE五个操作，在执行完这一条指令的A操作之后，下一条指令的A操作同时被加载进来开始执行，这样子效率会很高。</p>
<p>当机器遇到条件跳转的时候，机器<strong>不能确定是否会进行跳转</strong>。处理器采用非常精密的<strong>分支预测逻辑</strong>来预测每一条条件跳转指令到底会不会执行。只要猜测还算可靠（现代处理器要求对条件跳转的预测准确度在百分之九十以上），那么流水线模型会运行得很好。一旦错误预测了一个条件跳转指令，那么意味着处理器要丢掉它为该跳转指令后所有指令已经做的工作，去一个新的，正确的跳转位置开始填充流水线。这意味着一个错误的预测会带来严重的惩罚——大约20~40个时钟周期的浪费。</p>
<p>处理器支持<strong>条件传送</strong>（condition move），这与条件跳转不同。后者改变的是控制流，而前者传递的是数据流。其实条件传送就是我们熟悉的三目运算符：<code>?:</code>。例如上面的返回差值绝对值的代码的条件传送版本就是：</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">int</span> absdiff(<span class="built_in">int</span> x, <span class="built_in">int</span> y)</div><div class="line">&#123;</div><div class="line">    <span class="built_in">int</span> <span class="literal">result</span>;</div><div class="line">    <span class="literal">result</span> = x &lt; y ? y - x : x - y;  </div><div class="line">    <span class="keyword">return</span> <span class="literal">result</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>与之等价的，能体现对应的汇编代码的原理的goto版本：<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">int cmovdiff(int x, int y)</div><div class="line">&#123;</div><div class="line">    int <span class="built_in">t1</span> = y - x<span class="comment">;</span></div><div class="line">    int <span class="built_in">t2</span> = x - y<span class="comment">;</span></div><div class="line">    int test = x &lt; y<span class="comment">;</span></div><div class="line">    if(test) <span class="built_in">t2</span> = <span class="built_in">t1</span><span class="comment">;</span></div><div class="line">    return <span class="built_in">t2</span><span class="comment">;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>C语言中的条件传送通用形式模板是这样的：</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="attr">vt</span> = <span class="keyword">then</span>-statement</div><div class="line"><span class="attr">v</span> = <span class="keyword">else</span>-statement</div><div class="line"><span class="attr">t</span> = text-expr</div><div class="line"><span class="keyword">if</span>(t) <span class="attr">v</span> = vt;</div></pre></td></tr></table></figure>
<p>可以看到：执行条件传送时，无需预测测试结果，而是把两个分支的运算都完成。处理器只是读取值，然后检查条件码，然后要么更新目标寄存器，要么保持不变。这会使得工作效率变高，因为它规避了预测错误带来的惩罚。</p>
<p>也不是所有的条件表达式都适合用条件传送的。如果两个表达式中有任意一个可能产生错误或者副作用，就会导致非法的行为，例如：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">readpointer</span><span class="params">(<span class="keyword">int</span> *xp)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> (xp ? *xp : <span class="number">0</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>乍一看似乎没什么问题：如果指针为空，则返回0，否则返回指针指向的整数。但其实这个实现是错误的。因为条件传送对指针 xp 的引用是一定会发生的，如果 xp 是一个空指针，会导致一个间接引用空指针的错误。</p>
<p>条件传送也不会总是改进效率。如果两个表达式需要做大量的计算，那么当对应的条件不满足时，所做的工作就白费了。编译器必须权衡条件传送多做的计算，和条件分支预测错误惩罚之间的相对性能。</p>
<h1 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h1><p>C语言提供多种循环结构，for、while 和 do while。但看到这里大家也明白，汇编里没有相应的高级抽象指令，而是通过用测试、条件码、跳转组合起来，形成循环的效果。</p>
<h2 id="do-while"><a href="#do-while" class="headerlink" title="do while"></a>do while</h2><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">// <span class="keyword">do</span> <span class="keyword">while</span> 的 C 语言代码：计算阶乘</div><div class="line"></div><div class="line"><span class="built_in">int</span> fact_dowhile(<span class="built_in">int</span> n)</div><div class="line">&#123;</div><div class="line">    <span class="built_in">int</span> <span class="literal">result</span> = <span class="number">1</span>;</div><div class="line">    <span class="keyword">do</span>&#123;</div><div class="line">        <span class="literal">result</span> *= n;</div><div class="line">        n--;</div><div class="line">    &#125;<span class="keyword">while</span>(n &gt; <span class="number">1</span>);</div><div class="line">    <span class="keyword">return</span> <span class="literal">result</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//等价的goto版本：</div><div class="line"></div><div class="line"><span class="built_in">int</span> fact_dowhile_goto(<span class="built_in">int</span> n)</div><div class="line">&#123;</div><div class="line">    <span class="built_in">int</span> <span class="literal">result</span> = <span class="number">1</span>;</div><div class="line">loop:</div><div class="line">    <span class="literal">result</span> *= n;</div><div class="line">    n--;</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(n&gt;<span class="number">1</span>)goto loop;</div><div class="line">    <span class="keyword">return</span> <span class="literal">result</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上述代码的汇编代码是：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">    movl    <span class="number">8</span>(%ebp), %edx   <span class="comment"># 获得变量n</span></div><div class="line">    movl    $1, %eax        <span class="comment"># int result = 1；</span></div><div class="line"> .L2:</div><div class="line">    imull   %edx, %eax      <span class="comment"># result *= n;</span></div><div class="line">    subl    $1, %edx        <span class="comment"># n--;</span></div><div class="line">    cmpl    $1, %edx        </div><div class="line">    jg      .L2             <span class="comment"># if(n&gt;1) loop</span></div><div class="line"></div><div class="line"><span class="comment"># return</span></div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>寄存器</th>
<th>变量</th>
<th>初始值</th>
</tr>
</thead>
<tbody>
<tr>
<td>%eax</td>
<td>result</td>
<td>1</td>
</tr>
<tr>
<td>%edx</td>
<td>n</td>
<td>n</td>
</tr>
</tbody>
</table>
<p>有的时候，确定哪些寄存器放的是什么值，会很有挑战性，特别是在循环代码中。看汇编代码时，理解他们的关系，关键是找到程序值和寄存器的映射关系。编译器常常试图将多个程序值映射到同一个寄存器上，最小化寄存器的使用率。</p>
<p>do-while循环的通用结构是：</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">//C语言代码</div><div class="line"><span class="keyword">do</span></div><div class="line">	<span class="keyword">Body</span></div><div class="line">	<span class="keyword">while</span> (Test);</div><div class="line"></div><div class="line">//<span class="keyword">goto</span>版本</div><div class="line"><span class="keyword">loop</span>:</div><div class="line">	<span class="keyword">Body</span></div><div class="line">	<span class="keyword">if</span> (Test)</div><div class="line">		<span class="keyword">goto</span> <span class="keyword">loop</span></div></pre></td></tr></table></figure>
<h2 id="while"><a href="#while" class="headerlink" title="while"></a>while</h2><p>while循环的通用结构是：</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">// C 语言 <span class="keyword">While</span></div><div class="line"><span class="keyword">while</span> (Test)</div><div class="line">	<span class="keyword">Body</span></div><div class="line"></div><div class="line">// <span class="keyword">goto</span> 版本</div><div class="line">    t = test-expr</div><div class="line">    <span class="keyword">if</span>(!t)</div><div class="line">        <span class="keyword">goto</span> done;</div><div class="line"></div><div class="line"><span class="keyword">loop</span>:</div><div class="line">    <span class="keyword">Body</span></div><div class="line">    t = test-expr</div><div class="line">    <span class="keyword">if</span>(t) <span class="keyword">goto</span> <span class="keyword">loop</span>;</div><div class="line"></div><div class="line">done:</div></pre></td></tr></table></figure>
<p>while 与 do-while 最大的区别是它先对 test-expr 求值，所以在第一次执行循环主体 Body 之前，循环就有可能终止。而 do-while 是一定会执行至少一次循环主体的。</p>
<h2 id="for"><a href="#for" class="headerlink" title="for"></a>for</h2><figure class="highlight ada"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">// C语言的<span class="keyword">for</span></div><div class="line"><span class="keyword">for</span> (Init; Test; Update)</div><div class="line">	<span class="keyword">Body</span></div><div class="line">	</div><div class="line">// 先转换到<span class="keyword">while</span></div><div class="line">Init;</div><div class="line"><span class="keyword">while</span> (Test) &#123;</div><div class="line">	<span class="keyword">Body</span></div><div class="line">	Update;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 转换成<span class="keyword">do</span>-<span class="keyword">while</span></div><div class="line">Init;</div><div class="line"><span class="keyword">if</span>(Test)</div><div class="line">    <span class="keyword">goto</span> done;</div><div class="line"><span class="keyword">do</span>&#123;</div><div class="line">    <span class="keyword">Body</span></div><div class="line">    Update</div><div class="line">&#125;<span class="keyword">while</span>(Test);</div><div class="line"></div><div class="line">done:</div><div class="line"></div><div class="line">//再转换到<span class="keyword">goto</span>代码</div><div class="line">    Init;</div><div class="line">    t = Test;</div><div class="line">    <span class="keyword">if</span>(!t)</div><div class="line">        <span class="keyword">goto</span> done;</div><div class="line"><span class="keyword">loop</span>:</div><div class="line">    <span class="keyword">Body</span>;</div><div class="line">    Update;</div><div class="line">    t = Test;</div><div class="line">    <span class="keyword">if</span>(t)</div><div class="line">        <span class="keyword">goto</span> <span class="keyword">loop</span>;</div><div class="line"></div><div class="line">done:</div></pre></td></tr></table></figure>
<h1 id="switch-语句"><a href="#switch-语句" class="headerlink" title="switch 语句"></a>switch 语句</h1><p>switch 语句可以根据一个整数索引值进行多重分支（multi-way branching）。处理具有多种预测可能的分支时，这种语句特别有用，而且提高了C语言代码的可读性。</p>
<p>通过使用一种数据结构，叫做<strong>跳转表</strong>（jump table），使得实现 switch 十分的高效。跳转表是一个数组，表项 i 是一个代码段地址，代码段是当索引值等于 i 时程序应采取的动作。开关索引值就是用来执行一个跳转表内数组引用，来确定目标指令的情况。和用一组很长的 if-else 嵌套不同，使用跳转表的优点是执行开关语句的时间和开关的数量无关。</p>
<p>下面通过一个具体的例子来讲解：</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">int</span> switch_eg (<span class="built_in">int</span> x, <span class="built_in">int</span> n)&#123;</div><div class="line">	<span class="built_in">int</span> <span class="literal">result</span> = x;</div><div class="line"></div><div class="line">	switch (n) &#123;</div><div class="line">		<span class="keyword">case</span> <span class="number">100</span>:</div><div class="line">			<span class="literal">result</span> *= <span class="number">13</span>;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line"></div><div class="line">		<span class="keyword">case</span> <span class="number">102</span>:</div><div class="line">			<span class="literal">result</span> += <span class="number">10</span>;</div><div class="line"></div><div class="line">		<span class="keyword">case</span> <span class="number">103</span>:</div><div class="line">			<span class="literal">result</span> += <span class="number">11</span>;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line"></div><div class="line">		<span class="keyword">case</span> <span class="number">104</span>:</div><div class="line">		<span class="keyword">case</span> <span class="number">106</span>:</div><div class="line">			<span class="literal">result</span> *= <span class="literal">result</span>;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line"></div><div class="line">		default:</div><div class="line">			<span class="literal">result</span> = <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">result</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个例子包含了很多特殊情况：</p>
<ol>
<li>共享的条件：104 和 106 会执行相同的部分。</li>
<li>没有break：102 会继续执行 103 的部分。这个要十分小心，一般Switch出现错误的源头就是忘了break。如果确定要这么用，最好写上注释。</li>
<li>缺失条件：101 和 105</li>
</ol>
<p>具体怎么办呢？使用跳转表。（你会发现<strong>表</strong>的解决方式在很多地方都有用：虚函数，继承，内存管理，动态规划等等。）下面的汇编代码就是跳转表：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="string">.section</span>    <span class="string">.rodata</span>         <span class="comment"># 只读数据</span></div><div class="line">    <span class="string">.align</span> 4                <span class="comment"># 对齐要求</span></div><div class="line"><span class="string">.L7</span>:</div><div class="line">    <span class="string">.long</span>   <span class="string">.L3</span>             <span class="comment"># x = 0 时选择，L3里操作是 result *= 13; goto done;</span></div><div class="line">    <span class="string">.long</span>   <span class="string">.L2</span>             <span class="comment"># x = 1 时选择，因为101是缺失条件，直接 goto default;</span></div><div class="line">    <span class="string">.long</span>   <span class="string">.L4</span>             <span class="comment"># x = 2 时选择，result += 10; 然后顺序执行，没有break</span></div><div class="line">    <span class="string">.long</span>   <span class="string">.L5</span>             <span class="comment"># x = 3 时选择，result += 11; goto done;</span></div><div class="line">    <span class="string">.long</span>   <span class="string">.L6</span>             <span class="comment"># x = 4 时选择，result *= result; goto done;</span></div><div class="line">    <span class="string">.long</span>   <span class="string">.L2</span>             <span class="comment"># x = 5 时选择，因为105是缺失条件，直接 goto default;</span></div><div class="line">    <span class="string">.long</span>   <span class="string">.L6</span>             <span class="comment"># x = 6 时选择，result *= result;  goto done;注意到104和106执行相同的部分</span></div></pre></td></tr></table></figure>
<p>对 switch 语句的处理是：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">movl    <span class="number">8</span>(%epb), %edx       <span class="comment"># 参数 x</span></div><div class="line">movl    <span class="number">12</span>(%epb), %eax      <span class="comment"># 参数 n</span></div><div class="line"></div><div class="line">subl    $10<span class="number">0</span>, %eax          <span class="comment"># n -= 100;</span></div><div class="line">cmpl    $6, %eax            </div><div class="line">ja      .L2                 <span class="comment"># if(n&gt;6) goto default;</span></div><div class="line">jmp     *.L7(,%eax,<span class="number">4</span>)       <span class="comment"># else goto *jumptable[index];</span></div></pre></td></tr></table></figure>
<p>C语言的原始代码是 100、102~106 这样的值，针对这些值编译器可以选择做出优化——编译器将 n 的值减去 100，把取值范围移动到 0~6 之间。根据 switch 的参数 n，决定是进入跳转表还是 default 分支。jmp 指令的操作数有前缀 * ，代表这是一个间接跳转，操作数指定一个存储器位置。跳转位置是跳转表里面保存的一个地址，由寄存器 <code>%eax</code> 给出的索引作为引导。（在数据结构部分可以知道如何将数组引用翻译成机器代码）</p>
<h1 id="编译C语言代码时注意事项"><a href="#编译C语言代码时注意事项" class="headerlink" title="编译C语言代码时注意事项"></a>编译C语言代码时注意事项</h1><p>采取比较低的优化等级，这样子才能看到一些特性，不至于因为被编译器优化而看不到我们想要的结果。</p>
<p><img src="http://osax8w13y.bkt.clouddn.com/6-C%20compling.png" alt=""></p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="http://www.cs.cmu.edu/~./213/schedule.html" target="_blank" rel="external">CMU 2017年春季学期 ICS课程网站</a></li>
</ul>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/06/25/csapp-5-Machine-Prog-Data/" rel="next" title="【CSAPP笔记】5. 汇编语言——数据">
                <i class="fa fa-chevron-left"></i> 【CSAPP笔记】5. 汇编语言——数据
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/06/26/csapp-7-Machine-Prog-Procedure/" rel="prev" title="【CSAPP笔记】7. 汇编语言——过程调用">
                【CSAPP笔记】7. 汇编语言——过程调用 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="chaz" />
          <p class="site-author-name" itemprop="name">chaz</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">96</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">13</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#条件码"><span class="nav-number">1.</span> <span class="nav-text">条件码</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#基础的整数算术操作"><span class="nav-number">1.1.</span> <span class="nav-text">基础的整数算术操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#设置条件码的特殊指令"><span class="nav-number">1.2.</span> <span class="nav-text">设置条件码的特殊指令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#访问条件码：SET指令"><span class="nav-number">1.3.</span> <span class="nav-text">访问条件码：SET指令</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#条件分支"><span class="nav-number">2.</span> <span class="nav-text">条件分支</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#jump-指令的字节编码"><span class="nav-number">2.1.</span> <span class="nav-text">jump 指令的字节编码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#翻译条件分支"><span class="nav-number">2.2.</span> <span class="nav-text">翻译条件分支</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#条件传送"><span class="nav-number">3.</span> <span class="nav-text">条件传送</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#循环"><span class="nav-number">4.</span> <span class="nav-text">循环</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#do-while"><span class="nav-number">4.1.</span> <span class="nav-text">do while</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#while"><span class="nav-number">4.2.</span> <span class="nav-text">while</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#for"><span class="nav-number">4.3.</span> <span class="nav-text">for</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#switch-语句"><span class="nav-number">5.</span> <span class="nav-text">switch 语句</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#编译C语言代码时注意事项"><span class="nav-number">6.</span> <span class="nav-text">编译C语言代码时注意事项</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考资料"><span class="nav-number">7.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">chaz</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  

  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  

  

  
  


  

  

</body>
</html>
